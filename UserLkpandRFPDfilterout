import os
import pandas as pd

# ========= USER INPUTS =========
# Source file containing case extension data
SOURCE_FILE = r"D:\Production\Source\CaseExtension_Source.csv"

# Lookup files
USER_LOOKUP_FILE = r"D:\Production\Lookup Files\User_Lkp.csv"
CONTACT_ORIGIN_FILTER_FILE = r"D:\Production\Lookup Files\Contact_Origin_Filter.csv"

# Output directory
OUTPUT_DIR = r"D:\Production\Output"

# ========= CONSTANTS =========
# Default IDs for user fields (UPDATE THESE VALUES)
DEFAULT_OWNER_ID = "PROVIDE_DEFAULT_OWNER_ID"
DEFAULT_CREATEDBY_LASTMODIFIED_ID = "PROVIDE_DEFAULT_CREATEDBY_LASTMODIFIED_ID"

CHUNK_SIZE = 50_000

# ========= END OF USER INPUTS =========


def load_user_lookup(path):
    """Load user lookup file and return simple mapping function"""
    if not os.path.exists(path):
        raise FileNotFoundError(f"User lookup file not found: {path}")
    
    df = pd.read_csv(path, dtype=str).fillna("")
    
    # Check for required columns
    if "Legacy_SF_Record_ID__c" not in df.columns or "Id" not in df.columns:
        raise ValueError(f"User lookup file must contain 'Legacy_SF_Record_ID__c' and 'Id' columns")
    
    # Strip whitespace from columns
    df["Legacy_SF_Record_ID__c"] = df["Legacy_SF_Record_ID__c"].astype(str).str.strip()
    df["Id"] = df["Id"].astype(str).str.strip()
    
    # Build simple mapping dictionary: Legacy_SF_Record_ID__c -> Id
    lookup_dict = {
        str(k).strip().lower(): str(v).strip()
        for k, v in zip(df["Legacy_SF_Record_ID__c"], df["Id"])
        if str(k).strip()
    }
    
    def map_user_id(legacy_id):
        """Simple lookup: Legacy_SF_Record_ID__c -> Id"""
        if not legacy_id or str(legacy_id).strip() == "":
            return ""
        
        legacy_id_lc = str(legacy_id).strip().lower()
        return lookup_dict.get(legacy_id_lc, "")
    
    return map_user_id


def load_contact_origin_filter(path):
    """Load Contact Origin filter file and return set of IDs to blank out"""
    if not os.path.exists(path):
        raise FileNotFoundError(f"Contact Origin filter file not found: {path}")
    
    df = pd.read_csv(path, dtype=str).fillna("")
    
    if "Id" not in df.columns:
        raise ValueError(f"Contact Origin filter file must contain 'Id' column")
    
    # Create set of IDs to filter out
    filter_ids = {
        str(id_val).strip().lower()
        for id_val in df["Id"]
        if str(id_val).strip()
    }
    
    return filter_ids


def main():
    os.makedirs(OUTPUT_DIR, exist_ok=True)
    
    if not os.path.exists(SOURCE_FILE):
        raise FileNotFoundError(f"Source file not found: {SOURCE_FILE}")
    
    print("üìñ Loading lookup files...")
    map_user_id = load_user_lookup(USER_LOOKUP_FILE)
    contact_origin_filter_ids = load_contact_origin_filter(CONTACT_ORIGIN_FILTER_FILE)
    
    # Prepare output file
    source_basename = os.path.splitext(os.path.basename(SOURCE_FILE))[0]
    main_output_file = os.path.join(OUTPUT_DIR, f"{source_basename}_mapped.csv")
    
    # Remove existing output file
    if os.path.exists(main_output_file):
        os.remove(main_output_file)
    
    reader = pd.read_csv(SOURCE_FILE, dtype=str, chunksize=CHUNK_SIZE)
    header_written = False
    total_rows = 0
    
    print("üîÑ Processing source file in chunks...")
    
    for chunk_idx, chunk in enumerate(reader, start=1):
        chunk = chunk.fillna("")
        
        # === USER LOOKUP FOR 3 FIELDS ===
        user_fields = ["OwnerId", "CreatedById", "LastModifiedById"]
        
        for col in user_fields:
            if col in chunk.columns:
                # Apply simple lookup
                chunk[col] = chunk[col].apply(map_user_id)
                
                # Set defaults for blank/unmapped values
                if col == "OwnerId":
                    mask = chunk[col].astype(str).str.strip() == ""
                    chunk.loc[mask, col] = DEFAULT_OWNER_ID
                else:  # CreatedById, LastModifiedById
                    mask = chunk[col].astype(str).str.strip() == ""
                    chunk.loc[mask, col] = DEFAULT_CREATEDBY_LASTMODIFIED_ID
        
        # === CONTACT_ORIGIN__C BLANKING ===
        if "Contact_Origin__c" in chunk.columns:
            # Blank out values that match filter IDs
            chunk["Contact_Origin__c"] = chunk["Contact_Origin__c"].apply(
                lambda val: "" if str(val).strip().lower() in contact_origin_filter_ids else val
            )
        
        # Write to main output
        chunk.to_csv(
            main_output_file,
            index=False,
            mode="a" if header_written else "w",
            header=not header_written,
            encoding="utf-8-sig",
        )
        header_written = True
        total_rows += len(chunk)
        
        print(f"‚úÖ Chunk {chunk_idx}: {len(chunk)} rows processed")
    
    # === SUMMARY ===
    print("\n" + "="*60)
    print("‚úÖ MAPPING COMPLETED!")
    print("="*60)
    print(f"üìä Total rows processed: {total_rows}")
    print(f"üìù Main output: {main_output_file}")
    
    main_size_mb = os.path.getsize(main_output_file) / (1024 * 1024)
    print(f"üìè Output file size: {main_size_mb:.2f} MB")


if __name__ == "__main__":
    main()

